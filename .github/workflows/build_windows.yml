name: Build Windows Portable

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (CI only)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          }
          pip install pyinstaller

      - name: Build with PyInstaller
        shell: pwsh
        run: |
          pyinstaller --noconfirm --clean --onedir --collect-all ultralytics --name GrapplingOverlay apps/windows/main.py

      - name: Build launcher with PyInstaller
        shell: pwsh
        run: |
          pyinstaller --noconfirm --clean --onedir --noconsole --name GrapplingOverlayLauncher apps/launcher/main.py

      - name: Verify exe output
        shell: pwsh
        run: |
          $outputDir = "dist/GrapplingOverlay"
          $exe = "$outputDir/GrapplingOverlay.exe"
          if (!(Test-Path $outputDir)) {
            throw "Expected output directory missing: $outputDir"
          }
          Get-ChildItem $outputDir | Select-Object Name, Length
          if (!(Test-Path $exe)) {
            Write-Host "PyInstaller output not found. Listing dist:"
            if (Test-Path "dist") { Get-ChildItem -Recurse dist | Select-Object FullName } else { Write-Host "dist/ does not exist" }
            throw "Expected exe missing: $exe"
          }

      - name: Run exe in test mode
        shell: cmd
        run: |
          dist\GrapplingOverlay\GrapplingOverlay.exe --test-mode
          if errorlevel 1 exit /b 1

      - name: Stage package root
        shell: pwsh
        run: |
          $packageRoot = "package_root"
          if (Test-Path $packageRoot) { Remove-Item -Recurse -Force $packageRoot }
          New-Item -ItemType Directory -Path $packageRoot | Out-Null
          Copy-Item -Recurse "dist/GrapplingOverlayLauncher/*" $packageRoot
          $appRoot = Join-Path $packageRoot "app"
          New-Item -ItemType Directory -Path $appRoot | Out-Null
          Copy-Item -Recurse "dist/GrapplingOverlay/*" $appRoot
          Get-ChildItem -Recurse $packageRoot | Select-Object FullName, Length

      - name: Run launcher self-test
        shell: cmd
        run: |
          package_root\GrapplingOverlayLauncher.exe --self-test
          if errorlevel 1 exit /b 1

      - name: Package GrapplingOverlay-Windows.zip
        shell: pwsh
        run: |
          $packageRoot = "package_root"
          $zip = Join-Path (Resolve-Path .) "GrapplingOverlay-Windows.zip"
          if (Test-Path $zip) { Remove-Item $zip }
          Push-Location (Resolve-Path .)
          Compress-Archive -Path "$packageRoot/*" -DestinationPath $zip -Exclude "*.zip"
          Pop-Location
          if (!(Test-Path $zip)) { throw "Expected zip missing: $zip" }
          Get-Item $zip | Select-Object Name, Length

      - name: Verify zip contents
        shell: pwsh
        run: |
          $zip = "GrapplingOverlay-Windows.zip"
          $nested = cmd /c "tar -tf $zip | findstr /i \".zip\""
          if ($LASTEXITCODE -eq 0) {
            throw "Nested zip(s) found: $nested"
          }

      - name: Generate latest.json with sha256
        shell: pwsh
        run: |
          $assets = @("GrapplingOverlay-Windows.zip")
          $assetInfo = @()
          foreach ($asset in $assets) {
            $hash = (Get-FileHash -Algorithm SHA256 $asset).Hash.ToLower()
            $assetInfo += @{ name = $asset; sha256 = $hash }
          }
          $version = "${{ github.ref_name }}"
          $payload = @{ version = $version; assets = $assetInfo } | ConvertTo-Json -Depth 3
          $payload | Out-File -FilePath "latest.json" -Encoding utf8
          Get-Item latest.json | Select-Object Name, Length

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GrapplingOverlay-Windows
          path: |
            GrapplingOverlay-Windows.zip
            latest.json

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          files: |
            GrapplingOverlay-Windows.zip
            latest.json
