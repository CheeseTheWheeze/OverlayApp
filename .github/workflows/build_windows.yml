name: Build Windows Portable

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python (CI only)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install build deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          if (Test-Path "requirements.txt") {
            pip install -r requirements.txt
          }
          pip install pyinstaller

      - name: Build with PyInstaller
        shell: pwsh
        run: |
          pyinstaller --noconfirm --clean --onedir --name GrapplingOverlay apps/windows/main.py

      - name: Verify exe output
        shell: pwsh
        run: |
          $outputDir = "dist/GrapplingOverlay"
          $exe = "$outputDir/GrapplingOverlay.exe"
          if (!(Test-Path $outputDir)) {
            throw "Expected output directory missing: $outputDir"
          }
          Get-ChildItem $outputDir | Select-Object Name, Length
          if (!(Test-Path $exe)) {
            Write-Host "PyInstaller output not found. Listing dist:"
            if (Test-Path "dist") { Get-ChildItem -Recurse dist | Select-Object FullName } else { Write-Host "dist/ does not exist" }
            throw "Expected exe missing: $exe"
          }

      - name: Run exe in test mode
        shell: pwsh
        run: |
          $exe = "dist/GrapplingOverlay/GrapplingOverlay.exe"
          & $exe --test-mode
          if ($LASTEXITCODE -ne 0) { throw "Test mode failed with exit code $LASTEXITCODE" }

      - name: Package zip (exe + deps)
        shell: pwsh
        run: |
          $zip = "GrapplingOverlay-windows.zip"
          if (Test-Path $zip) { Remove-Item $zip }
          Compress-Archive -Path "dist/GrapplingOverlay" -DestinationPath $zip
          if (!(Test-Path $zip)) { throw "Expected zip missing: $zip" }
          Get-Item $zip | Select-Object Name, Length

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GrapplingOverlay-windows
          path: GrapplingOverlay-windows.zip
